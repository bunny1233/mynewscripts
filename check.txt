# Method 2: Registry-based permanent disable
function Disable-DefenderViaRegistry {
    # Registry paths
    $defenderPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender"
    $realTimePath = "$defenderPath\Real-Time Protection"
    
    # Create keys if they don't exist
    if (-not (Test-Path $defenderPath)) {
        New-Item -Path $defenderPath -Force | Out-Null
    }
    if (-not (Test-Path $realTimePath)) {
        New-Item -Path $realTimePath -Force | Out-Null
    }
    
    # Disable Defender completely
    New-ItemProperty -Path $defenderPath -Name "DisableAntiSpyware" -Value 1 -PropertyType DWORD -Force | Out-Null
    New-ItemProperty -Path $defenderPath -Name "DisableAntiVirus" -Value 1 -PropertyType DWORD -Force | Out-Null
    
    # Disable real-time protection
    New-ItemProperty -Path $realTimePath -Name "DisableRealtimeMonitoring" -Value 1 -PropertyType DWORD -Force | Out-Null
    New-ItemProperty -Path $realTimePath -Name "DisableBehaviorMonitoring" -Value 1 -PropertyType DWORD -Force | Out-Null
    New-ItemProperty -Path $realTimePath -Name "DisableIOAVProtection" -Value 1 -PropertyType DWORD -Force | Out-Null
    New-ItemProperty -Path $realTimePath -Name "DisableScriptScanning" -Value 1 -PropertyType DWORD -Force | Out-Null
    
    # Also disable via service
    Stop-Service -Name "WinDefend" -Force -ErrorAction SilentlyContinue
    Set-Service -Name "WinDefend" -StartupType Disabled -ErrorAction SilentlyContinue
    
    Write-Host "Defender disabled via registry (persistent after reboot)" -ForegroundColor Green
}

# Run as admin
if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Start-Process powershell "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

Disable-DefenderViaRegistry
