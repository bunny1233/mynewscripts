# Download and Extract Chrome Decryption Tool
# ===========================================

# Configuration
$zipUrl = "https://github.com/xaitax/Chrome-App-Bound-Encryption-Decryption/releases/download/v0.17.3/chrome-injector-v0.17.3.zip"
$tempDir = "$env:TEMP\ChromeDecryptor"
$extractDir = "$env:TEMP\ChromeDecryptor\Extracted"
$zipPath = "$env:TEMP\ChromeDecryptor\chrome-injector.zip"

Write-Host "üîß Chrome Decryption Tool Downloader" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan

# Create temp directory
Write-Host "`nüìÅ Creating directories..." -ForegroundColor Yellow
if (-not (Test-Path $tempDir)) {
    New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
    Write-Host "‚úì Created: $tempDir" -ForegroundColor Green
}

if (-not (Test-Path $extractDir)) {
    New-Item -ItemType Directory -Path $extractDir -Force | Out-Null
    Write-Host "‚úì Created: $extractDir" -ForegroundColor Green
}

# Download the file
Write-Host "`n‚¨áÔ∏è  Downloading Chrome decryption tool..." -ForegroundColor Yellow
Write-Host "  From: $zipUrl" -ForegroundColor Gray
Write-Host "  To: $zipPath" -ForegroundColor Gray

try {
    # Download with progress
    $ProgressPreference = 'SilentlyContinue'
    Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
    
    # Verify download
    if (Test-Path $zipPath) {
        $fileSize = (Get-Item $zipPath).Length / 1MB
        Write-Host "‚úÖ Download complete!" -ForegroundColor Green
        Write-Host "  File size: $($fileSize.ToString('0.00')) MB" -ForegroundColor Cyan
    } else {
        Write-Host "‚ùå Download failed - file not found" -ForegroundColor Red
        exit 1
    }
} catch {
    Write-Host "‚ùå Download error: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# Extract the zip file
Write-Host "`nüì¶ Extracting files..." -ForegroundColor Yellow

try {
    # Extract using Expand-Archive (PowerShell 5.1+)
    Expand-Archive -Path $zipPath -DestinationPath $extractDir -Force
    
    # Count extracted files
    $extractedFiles = Get-ChildItem -Path $extractDir -Recurse -File
    $extractedFolders = Get-ChildItem -Path $extractDir -Recurse -Directory
    
    Write-Host "‚úÖ Extraction complete!" -ForegroundColor Green
    Write-Host "  Files: $($extractedFiles.Count)" -ForegroundColor Cyan
    Write-Host "  Folders: $($extractedFolders.Count)" -ForegroundColor Cyan
    
} catch {
    Write-Host "‚ùå Extraction error: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "  Trying alternative method..." -ForegroundColor Yellow
    
    # Alternative: Use .NET if Expand-Archive fails
    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $extractDir)
        Write-Host "‚úÖ Extraction successful (alternative method)" -ForegroundColor Green
    } catch {
        Write-Host "‚ùå Both extraction methods failed" -ForegroundColor Red
        exit 1
    }
}

# Show extracted contents
Write-Host "`nüìã Extracted contents:" -ForegroundColor Yellow
$rootItems = Get-ChildItem -Path $extractDir
foreach ($item in $rootItems) {
    if ($item.PSIsContainer) {
        Write-Host "  üìÅ $($item.Name)" -ForegroundColor Cyan
    } else {
        Write-Host "  üìÑ $($item.Name)" -ForegroundColor Green
    }
}

# Save folder path to variable
$chromeDecryptorPath = $extractDir
Write-Host "`nüìç Folder path saved to variable:" -ForegroundColor Yellow
Write-Host "  `$chromeDecryptorPath = '$chromeDecryptorPath'" -ForegroundColor Cyan

# Also save to environment variable for later use
[Environment]::SetEnvironmentVariable("CHROME_DECRYPTOR_PATH", $extractDir, "User")
Write-Host "  Environment variable set: CHROME_DECRYPTOR_PATH" -ForegroundColor Gray

# Show full path in clipboard (optional)
$chromeDecryptorPath | Set-Clipboard
Write-Host "  Path copied to clipboard" -ForegroundColor Gray

# Test if the tool works
Write-Host "`nüîç Testing the tool..." -ForegroundColor Yellow
$exeFiles = Get-ChildItem -Path $extractDir -Recurse -Filter "*.exe"
if ($exeFiles.Count -gt 0) {
    Write-Host "‚úÖ Found executable files:" -ForegroundColor Green
    foreach ($exe in $exeFiles) {
        Write-Host "  ‚Üí $($exe.Name)" -ForegroundColor Cyan
    }
} else {
    Write-Host "‚ö†Ô∏è  No executable files found" -ForegroundColor Yellow
}

# Summary
Write-Host "`n" + "="*50 -ForegroundColor Cyan
Write-Host "üìä SUMMARY" -ForegroundColor Cyan
Write-Host "="*50 -ForegroundColor Cyan
Write-Host "‚Ä¢ Download URL: $zipUrl" -ForegroundColor Gray
Write-Host "‚Ä¢ Temp folder: $tempDir" -ForegroundColor Gray
Write-Host "‚Ä¢ Extract folder: $extractDir" -ForegroundColor Gray
Write-Host "‚Ä¢ Files extracted: $(Get-ChildItem -Path $extractDir -Recurse -File | Measure-Object | Select-Object -ExpandProperty Count)" -ForegroundColor Gray
Write-Host "‚Ä¢ Folder size: $([math]::Round((Get-ChildItem -Path $extractDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB, 2)) MB" -ForegroundColor Gray
Write-Host "‚Ä¢ Path variable: `$chromeDecryptorPath" -ForegroundColor Cyan

Write-Host "`n‚úÖ Chrome decryption tool ready to use!" -ForegroundColor Green
